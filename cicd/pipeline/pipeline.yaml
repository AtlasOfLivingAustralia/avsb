AWSTemplateFormatVersion: '2010-09-09'
Description: Code pipeline for the AVSB site

Parameters:
  pAppStackName:
    Type: String
    Description: The name of the application stack
  pArtifactsBucket:
    Type: String
    Description: Common artifacts bucket used by CodePipeline and CodeBuild
  pAutoDeploy:
    Type: String
    Description: Sets the pipeline to autodeploy on repo changes
  pCleanBranch:
    Type: String
    Description: A cleaned version of the code branch name
    Default: development
  pCloudFormationServiceRole:
    Type: String
    Description: Common service role used by Cloudformation
  pCodeBuildServiceRole:
    Type: String
    Description: Common service role used by CodeBuild
  pCodePipelineServiceRole:
    Type: String
    Description: Common service role used by CodePipeline
  pCodestarConnection:
    Type: String
    Description: Codestar connection ARN
  pEnvironment:
    Type: String
    Description: The AWS environment this belongs to
  pGitHubRepositoryName:
    Type: String
    Description: GitHub repository name.
  pGitHubOwner:
    Type: String
    Description: GitHub owner
  pGitHubBranch:
    Type: String
    Description: GitHub branch we're deploying from
  pProductComponent:
    Type: String
    Description: The name of the product component
  pProductName:
    Type: String
    Description: The name of the product
  pWafStackName:
    Type: String
    Description: The name of the product

Conditions:
  IsDev: !Equals
    - !Ref pEnvironment
    - development


Resources:
  ExportConfig:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub
              - "${pProductName}-${pProductComponent}-export-config-${ResourceName}"
              - ResourceName: !If [ IsDev, !Ref pCleanBranch, !Ref pEnvironment ]
      Description: Load the environment and build the CloudFormation template config file
      ServiceRole: !Ref pCodeBuildServiceRole
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:6.0
        EnvironmentVariables:
          - Name: AWS_ARTIFACTS_BUCKET
            Value: !Ref pArtifactsBucket
          - Name: CLEAN_BRANCH
            Value: !Ref pCleanBranch
          - Name: ENVIRONMENT
            Value: !Ref pEnvironment
      Source:
        Type: CODEPIPELINE
        BuildSpec: cicd/pipeline/export_config_buildspec.yaml
      TimeoutInMinutes: 5

  BuildCode:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub
              - "${pProductName}-${pProductComponent}-build-site-${ResourceName}"
              - ResourceName: !If [ IsDev, !Ref pCleanBranch, !Ref pEnvironment ]
      Description: Build the AVSB site
      ServiceRole: !Ref pCodeBuildServiceRole
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        EnvironmentVariables:
          - Name: 'AWS_ARTIFACTS_BUCKET'
            Value: !Ref pArtifactsBucket
      Source:
        Type: CODEPIPELINE
        BuildSpec: cicd/pipeline/npm_build_buildspec.yaml
      TimeoutInMinutes: 10

  EmptyBucket:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub
              - "${pProductName}-${pProductComponent}-empty-bucket-${ResourceName}"
              - ResourceName: !If [ IsDev, !Ref pCleanBranch, !Ref pEnvironment ]
      Description: Empty the source s3 bucket so it can be deleted
      ServiceRole: !Ref pCodeBuildServiceRole
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:5.0
        EnvironmentVariables:
          - Name: 'AWS_ARTIFACTS_BUCKET'
            Value: !Ref pArtifactsBucket
      Source:
        Type: CODEPIPELINE
        BuildSpec: cicd/pipeline/empty_bucket_buildspec.yaml
      TimeoutInMinutes: 5

  Pipeline:
    Type: 'AWS::CodePipeline::Pipeline'
    Properties:
      Name: !Sub
              - "${pProductName}-${pProductComponent}-${ResourceName}"
              - ResourceName: !If [ IsDev, !Ref pCleanBranch, !Ref pEnvironment ]
      RoleArn: !Ref pCodePipelineServiceRole
      ArtifactStores:
        - ArtifactStore:
            Type: S3
            Location: !Ref pArtifactsBucket
          Region: us-west-1
        - ArtifactStore:
            Type: S3
            Location: !Ref pArtifactsBucket
          Region: !Ref AWS::Region
      DisableInboundStageTransitions:
        - Reason: To prevent accidental teardown
          StageName: Teardown
      Stages:
        - Name: Checkout_Source
          Actions:
            - Name: CheckoutSrc
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: 1
              Configuration:
                ConnectionArn: !Ref pCodestarConnection
                FullRepositoryId: !Sub ${pGitHubOwner}/${pGitHubRepositoryName}
                BranchName: !Ref pGitHubBranch
                OutputArtifactFormat: CODE_ZIP
                DetectChanges: !Ref pAutoDeploy
              Namespace: CheckoutSrcNS
              OutputArtifacts:
                - Name: 'AvsbSourceArtifact'
        - Name: Deploy_Infrastructure
          Actions:
            - Name: ExportConfig
              ActionTypeId:
                Owner: AWS
                Category: Build
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref ExportConfig
                EnvironmentVariables: |
                  [
                    { "name":"SRC_BRANCH", "value":"#{CheckoutSrcNS.BranchName}" },
                    { "name":"COMMIT_ID", "value":"#{CheckoutSrcNS.CommitId}" }
                  ]
              Namespace: ExportConfigNS
              InputArtifacts:
                - Name: 'AvsbSourceArtifact'
              OutputArtifacts:
                - Name: ExportConfigArtifact
              RunOrder: 1
            - Name: DeployCFStackSite
              ActionTypeId:
                Owner: AWS
                Category: Deploy
                Version: 1
                Provider: CloudFormation
              Configuration:
                TemplatePath: 'ExportConfigArtifact::cicd/app/avsb.yaml'
                TemplateConfiguration: 'ExportConfigArtifact::cicd/pipeline/template_config.json'
                ActionMode: REPLACE_ON_FAILURE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn: !Ref pCloudFormationServiceRole
                StackName: !Ref pAppStackName
              InputArtifacts:
                - Name: 'ExportConfigArtifact'
              Namespace: AppCloudFormationOutNS
              OutputArtifacts: []
              RunOrder: 2
            - Name: DeployCFStackWaf
              ActionTypeId:
                Owner: AWS
                Category: Deploy
                Version: 1
                Provider: CloudFormation
              Configuration:
                TemplatePath: 'ExportConfigArtifact::cicd/app/waf.yaml'
                TemplateConfiguration: 'ExportConfigArtifact::cicd/pipeline/waf_template_config.json'
                ActionMode: REPLACE_ON_FAILURE
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                ParameterOverrides: |
                  { 
                    'pCloudFrontArn': '#{AppCloudFormationOutNS.AvsbCloudFrontDistributionArn}'
                  }
                RoleArn: !Ref pCloudFormationServiceRole
                StackName: !Ref pWafStackName
              InputArtifacts:
                - Name: 'ExportConfigArtifact'
              Namespace: WafCloudFormationOutNS
              OutputArtifacts: []
              Region: us-east-1
              RunOrder: 3
        - Name: Publish_Website
          Actions:
            - Name: BuildCode
              ActionTypeId:
                Owner: AWS
                Category: Build
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref BuildCode
                EnvironmentVariables: |
                  [
                    { "name":"SRC_BRANCH", "value":"#{CheckoutSrcNS.BranchName}" },
                    { "name":"ENVIRONMENT", "value":"#{ExportConfigNS.ENVIRONMENT}" },
                    { "name":"COMMIT_ID", "value":"#{CheckoutSrcNS.CommitId}" }
                  ]
              Namespace: BuildAvsbNS
              InputArtifacts:
                - Name: 'AvsbSourceArtifact'
              OutputArtifacts:
                - Name: BuildAvsbArtifact
              RunOrder: 1
            - Name: EmptyBucket
              ActionTypeId:
                Owner: AWS
                Category: Build
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref EmptyBucket
                EnvironmentVariables: |
                  [
                    { "name":"SOURCE_BUCKET", "value":"#{ExportConfigNS.SOURCE_BUCKET}" },
                    { "name":"BUCKET_PATH", "value":"#{ExportConfigNS.BUCKET_PATH}" }
                  ]
              Namespace: EmptyBucketPreDeployNS
              InputArtifacts:
                - Name: 'AvsbSourceArtifact'
              RunOrder: 2
            - Name: UploadFilesToS3
              ActionTypeId:
                Owner: AWS
                Category: Deploy
                Version: 1
                Provider: S3
              Configuration:
                BucketName: '#{ExportConfigNS.SOURCE_BUCKET}'
                ObjectKey: '#{ExportConfigNS.BUCKET_PATH}'
                Extract: 'true'
                CacheControl: 'public, max-age=#{ExportConfigNS.MAX_AGE}'
              OutputArtifacts: []
              InputArtifacts:
                - Name: BuildAvsbArtifact
              RunOrder: 3
        - Name: Teardown
          Actions:
            - Name: Approval
              ActionTypeId:
                Owner: AWS
                Category: Approval
                Version: 1
                Provider: Manual
              Configuration:
                CustomData: Approval required to tear down this stack
              RunOrder: 1
            - Name: EmptyBucket
              ActionTypeId:
                Owner: AWS
                Category: Build
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref EmptyBucket
                EnvironmentVariables: '[
                  { "name":"SOURCE_BUCKET", "value":"#{ExportConfigNS.SOURCE_BUCKET}" },
                  { "name":"BUCKET_PATH", "value":"#{ExportConfigNS.BUCKET_PATH}" }
                  ]'
              Namespace: EmptyBucketPreDeleteNS
              InputArtifacts:
                - Name: 'AvsbSourceArtifact'
              RunOrder: 2
            - Name: TeardownAvsb
              ActionTypeId:
                Owner: AWS
                Category: Deploy
                Version: 1
                Provider: CloudFormation
              Configuration:
                ActionMode: DELETE_ONLY
                StackName: !Ref pAppStackName
                RoleArn: !Ref pCloudFormationServiceRole
              RunOrder: 3
            - Name: ApprovalForPipelineTeardown
              ActionTypeId:
                Owner: AWS
                Category: Approval
                Version: 1
                Provider: Manual
              Configuration:
                CustomData: Approval required to tear down this stack
              RunOrder: 4
            - Name: TeardownCodePipeline
              ActionTypeId:
                Owner: AWS
                Category: Deploy
                Version: 1
                Provider: CloudFormation
              Configuration:
                ActionMode: DELETE_ONLY
                StackName: !Ref AWS::StackName
                RoleArn: !Ref pCloudFormationServiceRole
              RunOrder: 5


  ExportConfigLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete 
    Properties:
      LogGroupName: !Sub
                       - /aws/codebuild/${ProjectName}
                       - ProjectName: !Ref ExportConfig
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
    
  BuildCodeLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub
                       - /aws/codebuild/${ProjectName}
                       - ProjectName: !Ref BuildCode
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
    
  EmptyBucketLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub
                       - /aws/codebuild/${ProjectName}
                       - ProjectName: !Ref EmptyBucket
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName


Outputs:
  PipelineUrl:
    Value: !Sub https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${Pipeline}
